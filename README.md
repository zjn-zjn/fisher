# Fisher

## 简介

一个高可用的分布式资产转移系统，基于本地事务+状态表模式，实现N个账户扣除资产，M个账户接收的操作。

### 使用场景

**充值场景：** 官方账户扣减，用户账户增加

**买卖场景：** A账户扣减，B账户增加，C账户收取分成，官方D账户收取手续费

**合买场景：** A账户和B账户扣减，C账户收取款项，官方D账户收取手续费

### 特色

- 预定义官方账户，官方账户与用户账户隔离，官方账户允许余额为负
- 不存在莫名其妙的增加和减少操作，所有资产转移都有迹可循，所有交易达到最终态时，账户余额总和为0
- 官方账户是个区间，交易过程中官方账户离散，避免热点官方账户
- 支持半成功，如A、B账户扣减完成时就算成功，C、D账户资产增加即可持续推进（除非手动调用回滚接口）
- 支持分库分表(跨库事务)

## 技术架构

系统采用三层架构：
- **Model层**：定义数据模型和请求结构
- **DAO层**：负责数据访问和事务处理
- **Service层**：实现业务逻辑和交易流程

## 快速使用

### 表结构

conf/ddl.sql 为数据库表结构定义

### 初始化

basic.InitWithDefault(dbs []*gorm.DB) 使用默认值初始化配置，默认单表

basic.InitWithConf(conf *TransferConf) 更丰富的配置初始化

### 操作接口

#### Transfer 转移接口

- 入参
    - req
        - TransferId 转移ID
        - UseHalfSuccess 是否使用半成功
        - ItemType 转移物品类型
        - FromBags 转移发起者
            - BagId 发起账户ID
            - Amount 扣减数量
            - ChangeType 扣减类型
            - Comment 扣减备注
        - ToBags 转移接收者
            - BagId 接收账户ID
            - Amount 增加数量
            - ChangeType 增加类型
            - Comment 增加备注
        - TransferScene 转移场景
        - Comment 转移备注
- 返回
    - error 转移错误原因

#### Rollback 回滚转移

- 入参
    - req
        - TransferId 回滚的转移ID
        - TransferScene 回滚的转移场景
- 返回
    - error 回滚错误原因

#### Inspection 检查推进

- 入参
    - lastTime 这个时间之前的所有历史交易状态检查与推进，需注意**如果转移还在进行中，会尝试回滚该转移**
- 返回
    - []error 推进产生错误的列表

## 最佳实践

- **唯一性保证**：务必保证不同转移之间的transfer_id和transfer_scene联合唯一
- **事务隔离级别**：推荐使用数据库事务隔离级别：`READ-COMMITTED`
- **定期检查**：建议设置定时任务执行Inspection接口，处理半成功状态的转移

## 性能与扩展

- 系统支持水平扩展，通过分表配置可扩展到多个分片
- 官方账户区间设计有效避免了热点账户问题
- 半成功机制提高了系统整体成功率和可用性
